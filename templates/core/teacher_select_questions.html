{% extends 'users/base.html' %}
{% block title %} প্রশ্ন নির্বাচন {% endblock %}

{% block content %}
    <div class="card-header">
            <h4 class="card-title mb-0">আমাদের সম্পর্কে</h4>
        </div>
        <div class="card-body">
            <p>
                ই-প্রশ্ন ব্যাংক-এ আপনাকে স্বাগতম! আমরা একটি অনলাইন প্ল্যাটফর্ম যা ছাত্রছাত্রীদের জন্য একটি সমৃদ্ধ প্রশ্ন
                ভান্ডার তৈরি করার লক্ষ্যে কাজ করছি।
                এখানে আপনি বিভিন্ন বিষয় এবং পরীক্ষার জন্য হাজার হাজার প্রশ্ন পাবেন যা আপনার প্রস্তুতিকে আরও শক্তিশালী
                করবে।
            </p>
            <p>
                আমাদের লক্ষ্য হলো শিক্ষার মান উন্নয়ন করা এবং সকলের জন্য জ্ঞানার্জন সহজলভ্য করা।
            </p>
    <div class="card-body">
        <div class="alert alert-info mt-4" role="alert">
            <h5><p class="text-center"> সকল ফিল্ড নির্বাচন করে "ফিল্টার প্রয়োগ করুন" বাটনে ক্লিক করুন।</p></h5>
        </div>
    </div>

    <form method="get" id="filterForm">
        <div class="row align-items-end">
            <div class="col-md-auto mb-3">
                <label for="classSelect" class="form-label fw-semibold">ক্লাস</label>
                <select name="class_id" id="classSelect" class="form-select" required style="width: 200px;">
                    <option value="">-- ক্লাস নির্বাচন করুন --</option>
                    {% for c in classes %}
                        <option value="{{ c.id }}" {% if request.GET.class_id == c.id|stringformat:"s" %}selected{% endif %}>
                            {{ c.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-auto mb-3">
                <label for="subjectSelect" class="form-label fw-semibold">বিষয়</label>
                <select name="subject_id" id="subjectSelect" class="form-select" required style="width: 200px;">
                    <option value="">-- বিষয় নির্বাচন করুন --</option>
                    {% for s in subjects %}
                        <option value="{{ s.id }}" {% if request.GET.subject_id == s.id|stringformat:"s" %}selected{% endif %}>
                            {{ s.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-auto mb-3">
                <label class="form-label fw-semibold">অধ্যায়</label>
                <button type="button" id="openChapterModalBtn" class="btn btn-outline-info w-100" data-bs-toggle="modal" data-bs-target="#chapterModal" disabled>
                    অধ্যায় নির্বাচন করুন
                </button>
                <input type="hidden" name="chapter_ids" id="hiddenChapterIds" value="{{ request.GET.chapter_ids }}">
            </div>
             <div id="selectedChaptersDisplay" class="col-12 mb-3 fw-semibold text-info"></div>
        </div>

        <div class="row align-items-end">
             <div class="col-md-auto mb-3">
                <label for="questionTypeSelect" class="form-label fw-semibold">প্রশ্নের ধরন</label>
                <select name="question_type" id="questionTypeSelect" class="form-select" required style="width: 200px;">
                    <option value="">-- প্রশ্নের ধরন --</option>
                    <option value="mcq" {% if request.GET.question_type == "mcq" %}selected{% endif %}>বহু নির্বাচনি</option>
                    <option value="creative" {% if request.GET.question_type == "creative" %}selected{% endif %}>সৃজনশীল</option>
                    <option value="short" {% if request.GET.question_type == "short" %}selected{% endif %}>সংক্ষিপ্ত</option>
                </select>
            </div>

            <div class="col-md-auto mb-3">
                <label for="questionCountInput" class="form-label fw-semibold">কতটি প্রশ্ন দেখাবে</label>
                <input type="number" name="question_count" id="questionCountInput" class="form-control" placeholder="যেমনঃ ২০" min="1" value="{{ request.GET.question_count|default:20 }}" style="width: 200px;">
            </div>

            <div class="col-md-auto mb-3">
                <button type="submit" class="btn btn-info">ফিল্টার প্রয়োগ করুন</button>
            </div>
        </div>
    </form>

    {% if show_questions %}
        <hr>
        <form method="post" action="{% url 'prepare_paper' %}">
            {% csrf_token %}
            <div>
                <h4 class="mt-4">প্রশ্ন তালিকা</h4>
                <div class="my-2">
                    <button type="button" id="selectAllBtn" class="btn btn-sm btn-info">সব সিলেক্ট করুন</button>
                    <button type="button" id="unselectAllBtn" class="btn btn-sm btn-warning">সব আনসিলেক্ট করুন</button>
                </div>
                {% for q in questions %}
                    <div class="card mb-2 p-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <input type="checkbox" name="question_ids" value="{{ q.id }}" id="q{{ q.id }}" class="form-check-input question-checkbox me-2">
                            <label for="q{{ q.id }}" class="form-check-label fw-semibold">{{ q.text }}</label>
                        </div>
                        <div class="text-end small text-muted">ID: {{ q.id }}</div>
                    </div>

                    {# --- যদি MCQ হয়, অপশন দেখান --- #}
                    {% comment %} Replace question_type checks with presence of option fields {% endcomment %}
                    {% if q.option_a or q.option_b or q.option_c or q.option_d %}
                        <ul class="list-group list-group-flush mt-2">
                            {% if q.option_a %}<li class="list-group-item">A. {{ q.option_a }}</li>{% endif %}
                            {% if q.option_b %}<li class="list-group-item">B. {{ q.option_b }}</li>{% endif %}
                            {% if q.option_c %}<li class="list-group-item">C. {{ q.option_c }}</li>{% endif %}
                            {% if q.option_d %}<li class="list-group-item">D. {{ q.option_d }}</li>{% endif %}
                        </ul>
                    {% else %}
                        {# non-mcq: যদি answer/text field থাকে #}
                        {% if q.answer %}
                            <div class="mt-2"><strong>Answer:</strong> {{ q.answer }}</div>
                        {% endif %}
                    {% endif %}

                    {# --- Correct option / answer (admin-এ যে ফিল্ড আছে তা দেখান) --- #}
                    {% if q.correct_option %}
                        <div class="mt-2"><span class="badge bg-success">Correct: {{ q.correct_option }}</span></div>
                    {% elif q.correct_answer %}
                        <div class="mt-2"><span class="badge bg-success">Correct: {{ q.correct_answer }}</span></div>
                    {% endif %}
                </div>
            {% empty %}
                <p class="text-danger mt-3">এই ফিল্টারে কোনো প্রশ্ন পাওয়া যায়নি।</p>
            {% endfor %}
            </div>

            {% if questions %}
            <hr>
            <h4 class="mt-4">পেপারের তথ্য</h4>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="schoolNameInput" class="form-label fw-semibold">প্রতিষ্ঠানের নাম</label>
                    <input type="text" name="school_name" id="schoolNameInput" class="form-control" placeholder="প্রতিষ্ঠানের নাম লিখুন" required/>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label fw-semibold">সময় (মিনিট)</label>
                    <input type="number" name="duration" class="form-control" placeholder="যেমনঃ 60" required/>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label fw-semibold">মোট নম্বর</label>
                    <input type="number" name="total_marks" class="form-control" placeholder="যেমনঃ 100" required/>
                </div>
            </div>
            <!-- <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" name="include_omr" id="omrSwitch">
                <label class="form-check-label" for="omrSwitch">OMR দেখান</label>
            </div> -->

            <button type="submit" class="btn btn-info mt-3">প্রশ্ন প্রস্তুত করুন</button>
            {% endif %}
        </form>
    {% endif %}

<div class="modal fade" id="chapterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">অধ্যায় নির্বাচন করুন</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between mb-3">
                    <button type="button" class="btn btn-sm btn-info" id="selectAllChapters">সব সিলেক্ট করুন</button>
                    <button type="button" class="btn btn-sm btn-warning" id="unselectAllChapters">সব আনসিলেক্ট করুন</button>
                </div>
                <div id="chapterList"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">বন্ধ করুন</button>
                <button type="button" class="btn btn-info" id="saveChaptersBtn" data-bs-dismiss="modal">সেভ করুন</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const classSelect = document.getElementById('classSelect');
    const subjectSelect = document.getElementById('subjectSelect');
    const openChapterModalBtn = document.getElementById('openChapterModalBtn');

    const chapterListDiv = document.getElementById('chapterList');
    const saveChaptersBtn = document.getElementById('saveChaptersBtn');
    const hiddenChapterIdsInput = document.getElementById('hiddenChapterIds');
    const selectedChaptersDisplay = document.getElementById('selectedChaptersDisplay');
    const selectAllChaptersBtn = document.getElementById('selectAllChapters');
    const unselectAllChaptersBtn = document.getElementById('unselectAllChapters');

    // --- ক্লাস ও বিষয় এর ড্রপডাউন ---
    async function loadSubjects(classId, selectedSubjectId = null) {
        subjectSelect.innerHTML = '<option value="">-- বিষয় নির্বাচন করুন --</option>';
        openChapterModalBtn.disabled = true;
        if (!classId) return;

        const response = await fetch(`{% url 'ajax_load_subjects' %}?class_id=${classId}`);
        const subjects = await response.json();

        subjects.forEach(s => {
            const option = new Option(s.name, s.id);
            if (selectedSubjectId && selectedSubjectId == s.id) {
                option.selected = true;
            }
            subjectSelect.appendChild(option);
        });

        if (selectedSubjectId) {
            subjectSelect.dispatchEvent(new Event('change'));
        }
    }

    classSelect.addEventListener('change', () => {
        loadSubjects(classSelect.value);
        hiddenChapterIdsInput.value = '';
        selectedChaptersDisplay.textContent = '';
    });

    // --- Modal-এর জন্য অধ্যায় লোড করা ---
    async function loadChaptersIntoModal(subjectId) {
        chapterListDiv.innerHTML = 'লোড হচ্ছে...';
        if (!subjectId) {
            chapterListDiv.innerHTML = '<p class="text-muted">একটি বিষয় নির্বাচন করুন।</p>';
            openChapterModalBtn.disabled = true;
            return;
        }

        openChapterModalBtn.disabled = false;
        // ✅✅✅ মূল পরিবর্তন: 'subject_ids' এর পরিবর্তে 'subject_id' ব্যবহার করা হচ্ছে ✅✅✅
        const response = await fetch(`{% url 'ajax_load_chapters' %}?subject_id=${subjectId}`);
        const chapters = await response.json();

        chapterListDiv.innerHTML = '';
        const preSelectedChapterIds = hiddenChapterIdsInput.value.split(',').filter(Boolean);

        if (chapters.length > 0) {
            chapters.forEach(ch => {
                const isChecked = preSelectedChapterIds.includes(String(ch.id));
                const checkboxHtml = `
                    <div class="form-check">
                        <input class="form-check-input chapter-checkbox" type="checkbox" value="${ch.id}" id="chapter-${ch.id}" ${isChecked ? 'checked' : ''}>
                        <label class="form-check-label" for="chapter-${ch.id}">${ch.name}</label>
                    </div>`;
                chapterListDiv.insertAdjacentHTML('beforeend', checkboxHtml);
            });
        } else {
            chapterListDiv.innerHTML = '<p class="text-danger">এই বিষয়ের জন্য কোনো অধ্যায় পাওয়া যায়নি।</p>';
        }
    }

    subjectSelect.addEventListener('change', () => {
        hiddenChapterIdsInput.value = '';
        selectedChaptersDisplay.textContent = '';
        loadChaptersIntoModal(subjectSelect.value);
    });

    // --- Modal-এর বাটনগুলোর কাজ ---
    saveChaptersBtn.addEventListener('click', () => {
        const selectedCheckboxes = chapterListDiv.querySelectorAll('.chapter-checkbox:checked');
        const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        const selectedNames = Array.from(selectedCheckboxes).map(cb => cb.nextElementSibling.textContent);

        hiddenChapterIdsInput.value = selectedIds.join(',');
        selectedChaptersDisplay.textContent = selectedNames.length > 0 ? `নির্বাচিত অধ্যায়: ${selectedNames.join(', ')}` : '';
    });

    selectAllChaptersBtn.addEventListener('click', () => chapterListDiv.querySelectorAll('.chapter-checkbox').forEach(cb => cb.checked = true));
    unselectAllChaptersBtn.addEventListener('click', () => chapterListDiv.querySelectorAll('.chapter-checkbox').forEach(cb => cb.checked = false));

    // --- পেইজ লোড হওয়ার সময় আগের ডেটা ধরে রাখা ---
    function initializeForm() {
        const initialClassId = classSelect.value;
        const initialSubjectId = "{{ request.GET.subject_id }}";

        if (initialClassId) {
            loadSubjects(initialClassId, initialSubjectId);
        }
    }

    initializeForm();

    // --- ADD: Select / Unselect all for question list ---
    const selectAllBtn = document.getElementById('selectAllBtn');
    const unselectAllBtn = document.getElementById('unselectAllBtn');

    function setAllQuestionCheckboxes(checked) {
        document.querySelectorAll('.question-checkbox').forEach(cb => cb.checked = checked);
    }

    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', () => setAllQuestionCheckboxes(true));
    }
    if (unselectAllBtn) {
        unselectAllBtn.addEventListener('click', () => setAllQuestionCheckboxes(false));
    }
});
</script>
{% endblock %}
