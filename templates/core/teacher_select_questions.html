{% extends 'users/base.html' %}
{% block title %} প্রশ্ন নির্বাচন {% endblock %}
{% block content %}
    <h3>প্রশ্ন নির্বাচন</h3>

    <form method="get" id="filterForm">
        <div class="mb-3" style="width: 250px;">
            <label for="classSelect" class="form-label fw-semibold">ক্লাস</label>
            <select name="class_id" id="classSelect" class="form-select" required>
                <option value="">-- ক্লাস নির্বাচন করুন --</option>
                {% for c in classes %}
                    <option value="{{ c.id }}"
                            {% if request.GET.class_id == c.id|stringformat:"s" %}selected{% endif %}>
                        {{ c.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3" style="width: 250px;">
            <label for="subjectSelect" class="form-label fw-semibold">বিষয়</label>
            <select name="subject_id" id="subjectSelect" class="form-select" required>
                <option value="">-- বিষয় নির্বাচন করুন --</option>
                {% for s in subjects %}
                    <option value="{{ s.id }}"
                            {% if request.GET.subject_id == s.id|stringformat:"s" %}selected{% endif %}>
                        {{ s.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3" style="width: 250px;">
            <label for="chapterSelect" class="form-label fw-semibold">অধ্যায়</label>
            <select name="chapter_id" id="chapterSelect" class="form-select" required>
                <option value="">-- অধ্যায় নির্বাচন করুন --</option>
                {% for ch in chapters %}
                    <option value="{{ ch.id }}"
                            {% if request.GET.chapter_id == ch.id|stringformat:"s" %}selected{% endif %}>
                        {{ ch.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3" style="width: 250px;">
            <label for="questionTypeSelect" class="form-label fw-semibold">প্রশ্নের ধরন</label>
            <select name="question_type" id="questionTypeSelect" class="form-select" required>
                <option value="">-- প্রশ্নের ধরন নির্বাচন করুন --</option>
                <option value="mcq" {% if request.GET.question_type == "mcq" %}selected{% endif %}>বহু নির্বাচনি</option>
                <option value="creative" {% if request.GET.question_type == "creative" %}selected{% endif %}>সৃজনশীল</option>
                <option value="short" {% if request.GET.question_type == "short" %}selected{% endif %}>সংক্ষিপ্ত উত্তর</option>
            </select>
        </div>

        <div class="mb-3" style="width: 250px;">
            <label for="questionCountInput" class="form-label fw-semibold">কতটি প্রশ্ন দেখাবে</label>
            <input type="number" name="question_count" id="questionCountInput" class="form-control"
                   placeholder="যেমনঃ ২০" min="1" value="{{ request.GET.question_count|default:20 }}">
        </div>

        <button type="submit" class="btn btn-info mb-4">ফিল্টার প্রয়োগ করুন</button>
        <!-- <button type="button" class="btn btn-success mb-4 ms-2" id="openCreateModalBtn">নতুন প্রশ্ন তৈরি করুন</button> -->
    </form>

    {% if show_questions %}
        <form method="post" action="{% url 'prepare_paper' %}">{% csrf_token %}
            <div>
                <div style="margin-bottom:8px" class="mt-4">
                    <button type="button" id="selectAllBtn" class="btn btn-sm btn-info">সিলেক্ট করুন</button>
                    <button type="button" id="unselectAllBtn" class="btn btn-sm btn-warning">আন সিলেক্ট করুন</button>
                </div>
                {% for q in questions %}
                    <div>
                        <input type="checkbox" name="question_ids" value="{{ q.id }}" id="q{{ q.id }}" class="question-checkbox">
                        <label for="q{{ q.id }}">{{ q.text|default:q }}{# fallback to object __str__ #}</label>
                    </div>
                {% empty %}
                    <p>কোন প্রশ্ন পাওয়া যায়নি।</p>
                {% endfor %}
            </div>

            <h4 class="mt-4">পেপারের তথ্য</h4>
            <div class="mb-3" style="width: 400px;">
                <label for="defaultFormControlInput" class="form-label fw-semibold">প্রতিষ্ঠানের নাম</label>
                <input type="text" name="school_name" id="defaultFormControlInput" class="form-control" placeholder="প্রতিষ্ঠানের নাম লিখুন"/>
            </div>

            <div class="mb-3" style="width: 250px;">
                <label class="form-label fw-semibold">সময় (মিনিট)</label>
                <input type="number" name="duration" class="form-control" placeholder="যেমনঃ 60"/>
            </div>

            <div class="mb-3" style="width: 250px;">
                <label class="form-label fw-semibold">মোট নম্বর</label>
                <input type="number" name="total_marks" class="form-control" placeholder="যেমনঃ 100"/>
            </div>

            <label><input type="checkbox" name="include_omr"/> OMR দেখান</label>
            <br>
            <button type="submit" class="btn btn-info" style="margin-top: 30px;">প্রশ্ন প্রস্তুত করুন</button>
        </form>
    {% else %}
        <div class="alert alert-info mt-4" role="alert">
            সকল ফিল্ড (ক্লাস, বিষয়, অধ্যায়, প্রশ্নের ধরন) নির্বাচন করুন এবং "ফিল্টার প্রয়োগ করুন" বাটনে ক্লিক করুন।
        </div>
    {% endif %}

    <script>
        // Select All / Unselect All handlers
        document.getElementById('selectAllBtn')?.addEventListener('click', function () {
            document.querySelectorAll('.question-checkbox').forEach(cb => cb.checked = true);
        });
        document.getElementById('unselectAllBtn')?.addEventListener('click', function () {
            document.querySelectorAll('.question-checkbox').forEach(cb => cb.checked = false);
        });

        // ---- Dependent dropdowns (main filter) ----
        const classSelect   = document.getElementById('classSelect');
        const subjectSelect = document.getElementById('subjectSelect');
        const chapterSelect = document.getElementById('chapterSelect');

        async function loadSubjects(classId) {
            subjectSelect.innerHTML = '<option value="">-- বিষয় নির্বাচন করুন --</option>';
            chapterSelect.innerHTML = '<option value="">-- অধ্যায় নির্বাচন করুন --</option>';
            if (!classId) return;
            const res  = await fetch(`{% url 'ajax_load_subjects' %}?class_id=${classId}`);
            const data = await res.json();
            data.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id; opt.textContent = s.name;
                opt.selected = ("{{ request.GET.subject_id }}" === String(s.id));
                subjectSelect.appendChild(opt);
            });
        }

        async function loadChapters(subjectId) {
            chapterSelect.innerHTML = '<option value="">-- অধ্যায় নির্বাচন করুন --</option>';
            if (!subjectId) return;
            const res  = await fetch(`{% url 'ajax_load_chapters' %}?subject_ids=${subjectId}`);
            const data = await res.json();
            data.forEach(ch => {
                const opt = document.createElement('option');
                opt.value = ch.id; opt.textContent = ch.name;
                opt.selected = ("{{ request.GET.chapter_id }}" === String(ch.id));
                chapterSelect.appendChild(opt);
            });
        }

        classSelect?.addEventListener('change', () => loadSubjects(classSelect.value));
        subjectSelect?.addEventListener('change', () => loadChapters(subjectSelect.value));

        // Optional: যদি ভিউ থেকে subjects/chapters না আসে, প্রথম লোডে AJAX দিয়ে ভরে দিন
        document.addEventListener('DOMContentLoaded', () => {
            const hasSubjects = subjectSelect.querySelectorAll('option').length > 1;
            const hasChapters = chapterSelect.querySelectorAll('option').length > 1;

            if (!hasSubjects && classSelect.value) {
                loadSubjects(classSelect.value).then(() => {
                    if ("{{ request.GET.subject_id }}") {
                        loadChapters("{{ request.GET.subject_id }}");
                    }
                });
            } else if (!hasChapters && subjectSelect.value) {
                loadChapters(subjectSelect.value);
            }
        });

        // ---- Modal handling (unchanged) ----
        const openBtn = document.getElementById('openCreateModalBtn');
        const modal = document.getElementById('createQuestionModal');
        const closeBtns = [document.getElementById('closeModalBtn'), document.getElementById('closeModalBtn2')];
        const modalSubmit = document.getElementById('modalSubmitBtn');
        const modalAlert = document.getElementById('modal_alert');

        function showModal() {
            const classId = document.getElementById('classSelect')?.value || '';
            document.getElementById('modal_class_id').value = classId;
            populateSubjects(classId);
            modal.style.display = 'block';
        }
        function hideModal() {
            modal.style.display = 'none';
            modalAlert.style.display = 'none';
        }
        openBtn?.addEventListener('click', showModal);
        closeBtns.forEach(b => b?.addEventListener('click', hideModal));

        async function populateSubjects(classId) {
            const subjSelect = document.getElementById('modal_subjects');
            subjSelect.innerHTML = '';
            if (!classId) return;
            const res = await fetch(`{% url 'ajax_load_subjects' %}?class_id=${classId}`);
            const data = await res.json();
            data.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id; opt.textContent = s.name;
                subjSelect.appendChild(opt);
            });
        }
        async function populateChaptersForSelectedSubjects() {
            const subjSelect = document.getElementById('modal_subjects');
            const selected = Array.from(subjSelect.selectedOptions).map(o => o.value).join(',');
            const res = await fetch(`{% url 'ajax_load_chapters' %}?subject_ids=${selected}`);
            const data = await res.json();
            const chapSelect = document.getElementById('modal_chapters');
            chapSelect.innerHTML = '';
            data.forEach(ch => {
                const opt = document.createElement('option');
                opt.value = ch.id; opt.textContent = ch.name;
                chapSelect.appendChild(opt);
            });
        }
        document.getElementById('modal_subjects')?.addEventListener('change', populateChaptersForSelectedSubjects);

        // CSRF helper
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        modalSubmit?.addEventListener('click', async function () {
            const form = document.getElementById('createQuestionForm');
            const formData = new FormData(form);
            const subjVals = Array.from(document.getElementById('modal_subjects').selectedOptions).map(o => o.value);
            subjVals.forEach(v => formData.append('subjects', v));
            const chapVals = Array.from(document.getElementById('modal_chapters').selectedOptions).map(o => o.value);
            chapVals.forEach(v => formData.append('chapters', v));
            formData.append('class_id', document.getElementById('modal_class_id').value || '');

            const csrftoken = getCookie('csrftoken');
            const res = await fetch("{% url 'create_question_from_modal' %}", {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken },
                body: formData
            });
            const data = await res.json();
            if (res.ok) {
                location.reload();
            } else {
                modalAlert.style.display = 'block';
                modalAlert.textContent = data.error || (data.errors ? data.errors.join('; ') : 'Unknown error');
            }
        });
    </script>
{% endblock %}
