{% extends 'users/base.html' %}
{% block title %}প্রশ্ন প্রস্তুত করুন{% endblock %}

{% block content %}
<style>
    /* improved masthead + paper styling */
    .paper {
        max-width: 980px;
        margin: 20px auto;
        padding: 22px 28px;
        background: #fff;
        color: #111;
        box-shadow: 0 6px 18px rgba(20,20,20,0.06);
        border-radius: 6px;
        font-family: 'Hind Siliguri', sans-serif !important;
    }
    .masthead {
        text-align: center;
        margin-bottom: 12px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    .school-title {
        font-size: 28px;
        font-weight: 700;
        letter-spacing: 0.6px;
        margin-bottom: 6px;
    }
    .paper-subtitle {
        font-size: 16px;
        color: #444;
        margin-bottom: 6px;
    }
    .meta-row {
        display: flex;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 6px;
    }
    .meta-badge {
        background: #f5f7fa;
        color: #222;
        padding: 6px 10px;
        border-radius: 14px;
        font-size: 13px;
        border: 1px solid #eceff3;
    }
    .chapters-list { margin-top:8px; color:#333; font-size:13px; }
    .chapters-list .chapter-name { margin-right:8px; display:inline-block; padding:4px 8px; background:#fff; border:1px solid #f0f0f0; border-radius:10px; font-size:13px; color:#333; }

    /* questions layout tweaks */
    .q-columns { display:flex; gap:28px; margin-top:12px; position:relative; }
    /* vertical divider between left and right columns */
    .q-columns::before{
        content: "";
        position: absolute;
        left: 50%;
        top: 8px;
        bottom: 8px;
        width: 2px;
        background: linear-gradient(#d0d0d0 0%, #b8b8b8 50%, #d0d0d0 100%);
        transform: translateX(-50%);
        border-radius: 1px;
        pointer-events: none;
    }
    .q-col { flex:1; }
    .q-text { font-weight:400; font-size:15px; margin-bottom:6px; }
    .question { margin-bottom:14px; }

    @media (max-width:900px) {
        .q-columns { flex-direction:column; gap:10px; }
        .q-columns::before { display:none; } /* hide divider on small screens */
        .school-title { font-size:22px; }
    }
    @media print {
        .q-columns::before { display:none; } /* hide divider when printing */
    }

    /* OMR - redesigned (compact) */
    .omr-wrap { margin-top:12px; font-size:13px; }
    .omr-header {
        display:flex;
        gap:10px;
        align-items:center;
        justify-content:center; /* center title since name/roll removed */
        margin-bottom:8px;
    }
    .omr-info { display:none; } /* name/roll removed */
    .info-boxes { display:flex; gap:8px; align-items:center; }
    .info-box-single { display:none; } /* hide previous boxes */
    .omr-title {
        font-weight:700;
        font-size:14px;
        color:#222;
    }

    /* note shown only when OMR sheet visible (it's inside the OMR card) */
    .omr-note {
        font-size:12.5px;
        color:#111;
        background: #fff;
        padding:8px 10px;
        border-left:4px solid #222;
        border-radius:3px;
        margin-bottom:8px;
        line-height:1.4;
    }

    /* multi-column flow for OMR rows (compact bubbles) */
    .omr-list {
        column-count: 3;
        column-gap: 12px;
    }
    .omr-item {
        display:flex;
        align-items:center;
        gap:8px;
        padding:6px 4px;
        border-bottom:1px dashed #f0f0f0;
        break-inside: avoid;
        -webkit-column-break-inside: avoid;
        page-break-inside: avoid;
    }
    .omr-qno {
        width:28px;
        font-weight:700;
        font-size:14px;
        text-align:center;
        color:#111;
    }

    .omr-bubbles {
        display:flex;
        gap:8px;
        align-items:center;
        flex-wrap:nowrap;
    }
    .omr-bubble {
        width:26px;
        height:26px;
        border-radius:50%;
        border:2px solid #222;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        font-size:12px;
        font-weight:600;
        background:#fff;
        box-shadow: 0 1px 0 rgba(0,0,0,0.03) inset;
    }

    /* small screen: reduce columns to 1 */
    @media (max-width:780px) {
        .omr-list { column-count: 1; }
        .omr-bubble { width:22px; height:22px; font-size:12px; }
        .info-box-single { width:120px; height:26px; font-size:12px; padding:0 6px; }
    }

    /* print */
    @media print {
        body { background: #fff; }
        .btn { display:none !important; }
        .paper { box-shadow:none; margin:0; max-width:100%; }
        .omr-list { column-count: 3; }
    }

    /* replace/extend your existing styles with these for option layout */
    .options { list-style: none; padding: 0; margin: 8px 0 0 0; display: grid; grid-template-columns: 1fr 1fr; gap: 8px 24px; }
    .option-item { display: flex; align-items: center; gap: 10px; font-weight: 400 !important; font-size: 14px; color: #111; }
    .opt-circle {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 2px solid #222;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 400;
        font-size: 13px;
        line-height: 1;
        background: #fff;
    }
    .option-text { display: inline-block; font-size: 14px; font-weight: 400 !important; }

    /* responsive: slightly smaller on small screens */
    @media (max-width: 680px) {
        .options { grid-template-columns: 1fr; }
        .option-item { font-size: 13px; gap: 8px; }
        .opt-circle { width: 24px; height: 24px; font-size: 12px; }
        .option-text { font-size: 13px; }
    }
</style>

<div class="paper">
    <div class="masthead">
        <div class="school-title">{{ school_name }}</div>
        <div class="paper-subtitle">
            {% if questions.0.class_name %}{{ questions.0.class_name.name }}{% endif %}
            {% if questions.0.subject %} — {{ questions.0.subject.name }}{% endif %}
        </div>

        <div class="meta-row">
            <div class="meta-badge">সময়: {{ duration_bn }} মিনিট</div>
            <div class="meta-badge">পূর্ণমান: {{ total_marks_bn }}</div>
            <!-- <div class="meta-badge">প্রশ্ন সংখ্যা: {{ questions_with_index|length }}</div> -->
        </div>

        {% if questions %}
            <div class="chapters-list">
                {% comment %} print unique chapters in order of appearance {% endcomment %}
                {% for q in questions %}
                    {% if q.chapter %}
                        {% ifchanged q.chapter.id %}
                            <span class="chapter-name">{{ q.chapter.name }}</span>
                        {% endifchanged %}
                    {% endif %}
                {% endfor %}
            </div>
        {% endif %}
            <div class="instructions">প্রশ্নপত্রে কোনো প্রকার দাগ/চিহ্ন দেওয়া যাবেনা।</div>
                 <!-- instruction/note (will only be visible when OMR card is visible) -->
            <div class="omr-note">
                দ্রষ্টব্যঃ সরবরাহকৃত বহুনির্বাচনি অভীক্ষার উত্তরপত্রে প্রশ্নের ক্রমিক নম্বরের বিপরীতে প্রদত্ত বর্ণসম্বলিত বৃত্তসমূহ হতে সঠিক উত্তরের বৃত্তটি ( ) বল পয়েন্ট কলম দ্বারা সম্পূর্ণ ভরাট করো।
            </div>
    </div>


    <!-- <div class="info-row">
        <div>সময় — {{ duration|default:"৪৫" }} মিনিট</div>
        <div>পূর্ণমান — {{ total_marks|default:"৩২" }}</div>
    </div> -->


    <div class="q-columns" id="questionsColumns">
        <div class="q-col left">
            {% for item in questions_with_index %}
                {% if not item.index|divisibleby:"2" %}
                    <div class="question">
                        <div class="q-text">{{ item.bn_index }}. {{ item.q.text|safe }}</div>
                        {% if item.q.option_a or item.q.option_b or item.q.option_c or item.q.option_d %}
                            <ul class="options">
                                {% if item.q.option_a %}<li class="option-item"><span class="opt-circle">ক</span><span class="option-text">{{ item.q.option_a }}</span></li>{% endif %}
                                {% if item.q.option_b %}<li class="option-item"><span class="opt-circle">খ</span><span class="option-text">{{ item.q.option_b }}</span></li>{% endif %}
                                {% if item.q.option_c %}<li class="option-item"><span class="opt-circle">গ</span><span class="option-text">{{ item.q.option_c }}</span></li>{% endif %}
                                {% if item.q.option_d %}<li class="option-item"><span class="opt-circle">ঘ</span><span class="option-text">{{ item.q.option_d }}</span></li>{% endif %}
                            </ul>
                        {% else %}
                            <div class="text-muted">উত্তর এখানে দেখানো হচ্ছে না।</div>
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <div class="q-col right">
            {% for item in questions_with_index %}
                {% if item.index|divisibleby:"2" %}
                    <div class="question">
                        <div class="q-text">{{ item.bn_index }}. {{ item.q.text|safe }}</div>
                        {% if item.q.option_a or item.q.option_b or item.q.option_c or item.q.option_d %}
                            <ul class="options">
                                {% if item.q.option_a %}<li class="option-item"><span class="opt-circle">ক</span><span class="option-text">{{ item.q.option_a }}</span></li>{% endif %}
                                {% if item.q.option_b %}<li class="option-item"><span class="opt-circle">খ</span><span class="option-text">{{ item.q.option_b }}</span></li>{% endif %}
                                {% if item.q.option_c %}<li class="option-item"><span class="opt-circle">গ</span><span class="option-text">{{ item.q.option_c }}</span></li>{% endif %}
                                {% if item.q.option_d %}<li class="option-item"><span class="opt-circle">ঘ</span><span class="option-text">{{ item.q.option_d }}</span></li>{% endif %}
                            </ul>
                        {% else %}
                            <div class="text-muted">উত্তর এখানে দেখানো হচ্ছে না।</div>
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
            <button id="omrToggleBtn" class="btn btn-outline-info btn-sm">
                {% if include_omr %}OMR দেখানো আছে{% else %}OMR দেখান{% endif %}
            </button>
        </div>
        <div><a href="#" onclick="window.print(); return false;" class="btn btn-secondary btn-sm">প্রিন্ট</a></div>
    </div>

    <div id="omrSheet" class="omr-wrap" style="display: {% if include_omr %}block{% else %}none{% endif %};">
        <div class="card p-2">
            <!-- header: boxes for roll/name and small squares -->
            <div class="omr-header">
                <div class="omr-title">OMR উত্তরপত্র</div>
            </div>

       

            <!-- OMR items flow into columns automatically -->
            <div class="omr-list" aria-hidden="true">
                {% for item in questions_with_index %}
                    <div class="omr-item">
                        <div class="omr-qno">{{ item.bn_index }}</div>
                        <div class="omr-bubbles">
                            <div class="omr-bubble">ক</div>
                            <div class="omr-bubble">খ</div>
                            <div class="omr-bubble">গ</div>
                            <div class="omr-bubble">ঘ</div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const omrToggleBtn = document.getElementById('omrToggleBtn');
    const omrSheet = document.getElementById('omrSheet');
    if (omrToggleBtn && omrSheet) {
        omrToggleBtn.addEventListener('click', () => {
            const shown = window.getComputedStyle(omrSheet).display !== 'none';
            omrSheet.style.display = shown ? 'none' : 'block';
            omrToggleBtn.textContent = shown ? 'OMR দেখান' : 'OMR দেখানো আছে';
        });
    }
});
</script>
{% endblock %}